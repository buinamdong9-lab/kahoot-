<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PLAYER · Physics Kahoot</title>
  <style>
    :root{
      --bg0:#060913; --bg1:#0b1430; --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12); --text:#eaf1ff; --muted:#9fb0d0;
      --accent:#66e3ff; --accent2:#8b7bff; --ok:#31c48d; --bad:#ff5a5f;
      --shadow:0 20px 60px rgba(0,0,0,.45); --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui; color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(102,227,255,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(139,123,255,.18), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.7;
      background:
        linear-gradient(to right, rgba(255,255,255,.045) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.045) 1px, transparent 1px);
      background-size: 44px 44px;
      mask-image: radial-gradient(closest-side at 50% 20%, rgba(0,0,0,.9), transparent 70%);
    }
    .app{width:min(760px,100%); margin:26px auto; padding:0 16px 40px}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;font-weight:900;
      background:linear-gradient(135deg, rgba(102,227,255,.25), rgba(139,123,255,.25));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 0 0 6px rgba(102,227,255,.05), 0 0 40px rgba(102,227,255,.12);
    }
    h1{margin:0;font-size:22px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);box-shadow:var(--shadow);backdrop-filter:blur(10px)}
    .panel{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);color:var(--text);
      width:min(320px,100%);
      outline:none;
    }
    button{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(135deg, rgba(102,227,255,.22), rgba(139,123,255,.22));
      color:var(--text);cursor:pointer;font-weight:800;
      transition:transform .12s ease, filter .12s ease;
    }
    button:hover{transform:translateY(-1px);filter:brightness(1.06)}
    button.secondary{background:rgba(255,255,255,.06)}
    button:disabled{opacity:.45;cursor:not-allowed;transform:none}
    .muted{color:var(--muted)}
    .pill{
      padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:13px;
      backdrop-filter: blur(10px);
    }
    .pill b{color:var(--text)}
    .qbox{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      border-radius:14px;padding:12px;margin-top:10px;
    }
    .opt{
      padding:12px;border-radius:14px;margin:10px 0;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);
      cursor:pointer; transition:transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex; gap:10px; align-items:flex-start;
      user-select:none;
    }
    .opt:hover{transform:translateY(-1px);border-color:rgba(102,227,255,.25);background:rgba(102,227,255,.06)}
    .opt.locked{cursor:not-allowed;opacity:.70;transform:none}
    .opt .n{
      width:28px;height:28px;border-radius:10px;display:grid;place-items:center;font-weight:900;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);color:var(--text)
    }
    .opt.picked{border-color:rgba(102,227,255,.45);background:rgba(102,227,255,.10)}
    .opt.correct{border-color:rgba(49,196,141,.45);background:rgba(49,196,141,.12)}
    .opt.wrong{border-color:rgba(255,90,95,.45);background:rgba(255,90,95,.10)}
    .msg{margin-top:10px}
    code{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="app">
    <div class="brand">
      <div class="logo">φ</div>
      <div>
        <h1>PLAYER · Physics Kahoot</h1>
        <div class="sub">Vào phòng bằng PIN + tên (không cần login)</div>
      </div>
    </div>

    <!-- JOIN -->
    <div class="card panel" id="joinCard">
      <div class="row">
        <input id="pin" placeholder="PIN (6 số)" autocomplete="off" />
        <input id="name" placeholder="Tên của bạn" autocomplete="off" />
        <button id="btnJoin">Vào phòng</button>
      </div>
      <div class="msg muted" id="joinMsg">Tip: Host tạo PIN ở <code>/host.html</code>.</div>
    </div>

    <!-- GAME -->
    <div class="card panel" id="gameCard" hidden>
      <div class="row" style="justify-content:space-between">
        <div class="pill">Phòng: <b id="room">—</b></div>
        <div class="pill">Trạng thái: <b id="state">—</b></div>
      </div>

      <div class="qbox">
        <div class="muted" id="qmeta">Chờ host…</div>
        <div style="margin-top:8px;font-weight:900" id="qtext">Chưa có câu hỏi.</div>
        <div id="opts"></div>
        <div class="msg muted" id="msg">Khi có câu hỏi, bấm 1 đáp án để gửi.</div>
      </div>

      <div class="row" style="margin-top:10px; justify-content:flex-end;">
        <button class="secondary" id="btnLeave">Rời phòng</button>
      </div>
    </div>
  </div>

  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ✅ Player là guest -> connect bình thường, KHÔNG token
    const socket = io();

    const joinCard = document.getElementById("joinCard");
    const gameCard = document.getElementById("gameCard");
    const joinMsg  = document.getElementById("joinMsg");

    const pinEl  = document.getElementById("pin");
    const nameEl = document.getElementById("name");

    const roomEl  = document.getElementById("room");
    const stateEl = document.getElementById("state");
    const qmeta   = document.getElementById("qmeta");
    const qtext   = document.getElementById("qtext");
    const opts    = document.getElementById("opts");
    const msg     = document.getElementById("msg");

    const btnJoin = document.getElementById("btnJoin");
    const btnLeave = document.getElementById("btnLeave");

    let roomCode = null;
    let locked = true;
    let pickedChoice = null;

    function setJoinMessage(t) {
      joinMsg.textContent = t || "";
    }

    function resetUIToWaiting() {
      stateEl.textContent = "đang chờ";
      qmeta.textContent = "Chờ host phát câu…";
      qtext.textContent = "Chưa có câu hỏi.";
      msg.className = "msg muted";
      msg.style.color = "";
      msg.textContent = "Chờ host…";
      opts.innerHTML = "";
      locked = true;
      pickedChoice = null;
    }

    btnJoin.onclick = () => {
      setJoinMessage("");
      const pin = pinEl.value.trim();
      const name = nameEl.value.trim();

      if (!pin) return setJoinMessage("Bạn chưa nhập PIN.");
      if (!name) return setJoinMessage("Bạn chưa nhập tên.");

      socket.emit("player:join", { roomCode: pin, name });
    };

    btnLeave.onclick = () => {
      // đơn giản: reload để thoát khỏi phòng
      location.reload();
    };

    socket.on("connect_error", (e) => {
      // Nếu server chưa chạy / sai port sẽ rơi vào đây
      setJoinMessage("Không kết nối được server. Kiểm tra server đang chạy chưa.");
      console.log("connect_error:", e.message);
    });

    socket.on("join:error", (m) => {
      setJoinMessage(m);
    });

    socket.on("join:ok", (data) => {
      roomCode = data.roomCode;

      roomEl.textContent = roomCode;
      joinCard.hidden = true;
      gameCard.hidden = false;

      resetUIToWaiting();

      if (!data.started) {
        stateEl.textContent = "chưa bắt đầu";
        qmeta.textContent = "Host chưa bắt đầu…";
      }
    });

    socket.on("game:started", () => {
      if (!roomCode) return;
      stateEl.textContent = "đã bắt đầu";
      qmeta.textContent = "Chờ câu hỏi…";
      msg.className = "msg muted";
      msg.style.color = "";
      msg.textContent = "Chờ host phát câu.";
    });

    socket.on("game:question", (data) => {
      locked = false;
      pickedChoice = null;

      stateEl.textContent = `câu ${data.index}/${data.total}`;
      qmeta.textContent = `Câu ${data.index}/${data.total}`;
      qtext.textContent = data.question.text;

      msg.className = "msg muted";
      msg.style.color = "";
      msg.textContent = "Bấm 1 đáp án để gửi (chỉ 1 lần).";

      opts.innerHTML = "";
      data.question.options.forEach((o, i) => {
        const div = document.createElement("div");
        div.className = "opt";
        div.innerHTML = `<div class="n">${i + 1}</div><div>${o}</div>`;
        div.onclick = () => choose(i);
        opts.appendChild(div);
      });
    });

    function choose(i) {
      if (locked) return;
      locked = true;
      pickedChoice = i;

      [...opts.children].forEach((d, idx) => {
        d.classList.add("locked");
        d.classList.toggle("picked", idx === i);
      });

      msg.className = "msg muted";
      msg.style.color = "";
      msg.textContent = "Đã gửi đáp án…";

      socket.emit("player:answer", { roomCode, choice: i });
    }

    socket.on("answer:received", () => {
      msg.className = "msg muted";
      msg.style.color = "";
      msg.textContent = "Server đã nhận. Chờ host reveal đáp án…";
    });

    socket.on("game:reveal", ({ correctIndex }) => {
      [...opts.children].forEach((d, idx) => {
        d.classList.add("locked");
        if (idx === correctIndex) d.classList.add("correct");
        if (pickedChoice !== null && idx === pickedChoice && pickedChoice !== correctIndex) d.classList.add("wrong");
      });

      if (pickedChoice === null) {
        msg.className = "msg muted";
        msg.style.color = "";
        msg.textContent = `Đáp án đúng là #${correctIndex + 1}.`;
      } else if (pickedChoice === correctIndex) {
        msg.className = "msg";
        msg.style.color = "#31c48d";
        msg.textContent = `✅ Bạn đúng! (Đáp án #${correctIndex + 1})`;
      } else {
        msg.className = "msg";
        msg.style.color = "#ff5a5f";
        msg.textContent = `❌ Bạn sai. Đáp án đúng: #${correctIndex + 1}`;
      }
    });

    socket.on("game:ended", () => {
      stateEl.textContent = "kết thúc";
      qmeta.textContent = "Game kết thúc";
      msg.className = "msg muted";
      msg.style.color = "";
      msg.textContent = "Cảm ơn bạn đã tham gia!";
      locked = true;
    });
  </script>
</body>
</html>
